// è¿‡æ»¤å™¨ã€FILTER_DANMAKU_MSGã€‘äº‹ä»¶ä¸­å“åº”æ­¤ä»£ç 
// å¯ä»¥åšåˆ° AI è¿‡æ»¤ä»£ç 
var name = danmaku.getNickname();
var danmu = danmaku.getText();
// console.log("è·å–åˆ°çš„å¼¹å¹•ï¼š" + name + "ï¼š" + danmu);
if (danmu == "" || danmu == null || danmu == undefined) {
    return "";
}

// ç¡®å®šæç¤ºè¯ï¼Œæ¸…é™¤æ•æ„Ÿè¯å’Œä¸é‡è¦å¼¹å¹•
var prompt = `# è§’è‰²
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¼¹å¹•å†…å®¹å®¡æ ¸ä¸ä»·å€¼è¯„ä¼°AIåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¯¹ç”¨æˆ·å‘é€çš„å¼¹å¹•è¿›è¡Œå¿«é€Ÿã€å‡†ç¡®çš„åˆ†ç±»ã€‚

# ä»»åŠ¡
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚å¯¹è¾“å…¥çš„å¼¹å¹•æ–‡æœ¬è¿›è¡Œåˆ†æå’Œåˆ†ç±»ï¼š

## åˆ†ç±»æ ‡å‡†
1.  **è¿è§„å¼¹å¹• (VIOLATION)**: åŒ…å«æˆ–æ¶‰åŠä»¥ä¸‹å†…å®¹ï¼š
    *   è‰²æƒ…ã€ä½ä¿—ã€è£¸éœ²æš—ç¤º
    *   æš´åŠ›ã€è¡€è…¥ã€ææ€–å¨èƒ
    *   æ­§è§†ã€ä»‡æ¨è¨€è®ºï¼ˆåœ°åŸŸã€ç§æ—ã€æ€§åˆ«ã€æ€§å–å‘ç­‰ï¼‰
    *   æ¶æ„äººèº«æ”»å‡»ã€ä¾®è¾±ã€è¯½è°¤
    *   è¿æ³•è¿è§„ä¿¡æ¯ï¼ˆæ¯’å“ã€èµŒåšã€è¯ˆéª—ã€è¿ç¦å“ï¼‰
    *   æ”¿æ²»æ•æ„Ÿå†…å®¹ï¼ˆè¿åå½“åœ°æ³•å¾‹æ³•è§„ï¼‰
    *   åƒåœ¾å¹¿å‘Šï¼ˆéå®˜æ–¹æ¨å¹¿ã€äºŒç»´ç ã€è”ç³»æ–¹å¼ï¼‰
    *   è¯±å¯¼ç‚¹å‡»/è·³è½¬ï¼ˆé’“é±¼ã€è¯ˆéª—é“¾æ¥ï¼‰
    *   **æ ¸å¿ƒç‰¹å¾ï¼š** è¿åæ³•å¾‹æ³•è§„æˆ–å¹³å°è§„å®šï¼Œå¯¹ä»–äººæˆ–ç¤¾åŒºé€ æˆä¼¤å®³æˆ–é£é™©ã€‚

2.  **é‡è¦å¼¹å¹• (IMPORTANT)**: æ»¡è¶³ä»¥ä¸‹ä¸€æ¡æˆ–å¤šæ¡ï¼Œä¸”**ä¸è¿è§„**ï¼š
    *   **ä¸å½“å‰ç›´æ’­/è§†é¢‘ä¸»é¢˜é«˜åº¦ç›¸å…³**ï¼šè®¨è®ºæ­£åœ¨å‘ç”Ÿçš„äº‹ä»¶ã€å±•ç¤ºçš„å†…å®¹ã€æ¸¸æˆè¿›ç¨‹ã€çŸ¥è¯†ç‚¹ç­‰ã€‚
    *   **æå‡ºæœ‰ä»·å€¼çš„é—®é¢˜**ï¼šå…³äºå†…å®¹æœ¬èº«çš„ç–‘é—®ã€æŠ€æœ¯æ¢è®¨ã€å¯»æ±‚å¸®åŠ©ï¼ˆéç®€å•é‡å¤ï¼‰ã€‚
    *   **æä¾›æœ‰ä»·å€¼çš„ä¿¡æ¯/è§£ç­”**ï¼šå›ç­”ä»–äººé—®é¢˜ã€è¡¥å……çŸ¥è¯†ç‚¹ã€çº æ­£é”™è¯¯ï¼ˆå‹å–„ï¼‰ã€‚
    *   **ç²¾å½©ç‚¹è¯„/æ·±åº¦è§è§£**ï¼šå¯¹å†…å®¹æœ‰ç‹¬åˆ°ã€æ·±åˆ»çš„åˆ†ææˆ–èµç¾ï¼ˆéæ— è„‘å¹ï¼‰ã€‚
    *   **ä¸»æ’­/UPä¸»/è§‚ä¼—äº’åŠ¨**ï¼š@ä¸»æ’­/UPä¸»çš„æœ‰æ„ä¹‰æé—®æˆ–åé¦ˆï¼ˆééªšæ‰°ï¼‰ã€‚
    *   **å…³é”®ä¿¡æ¯é€šçŸ¥**ï¼šæé†’ä¸»æ’­å¤±è¯¯ã€å±é™©æ“ä½œã€é‡è¦æ¶ˆæ¯ï¼ˆå¦‚æ¯”èµ›å…³é”®ç‚¹ï¼‰ã€‚
    *   **æ ¸å¿ƒç‰¹å¾ï¼š** å¯¹è§‚çœ‹è€…ç†è§£å†…å®¹ã€ä¸ä¸»æ’­äº’åŠ¨ã€æå‡ç¤¾åŒºæ°›å›´æœ‰æ˜¾è‘—ç§¯æä»·å€¼ã€‚

3.  **ä¸é‡è¦å¼¹å¹• (LOW_VALUE)**: æ»¡è¶³ä»¥ä¸‹ä¸€æ¡æˆ–å¤šæ¡ï¼Œä¸”**ä¸è¿è§„**ï¼Œä¹Ÿ**ä¸æ»¡è¶³é‡è¦å¼¹å¹•æ ‡å‡†**ï¼š
    *   **æ— æ„ä¹‰å†…å®¹**ï¼šçº¯ç¬¦å· (å¦‚ \`...\` \`!!!\`)ã€æ— æ„ä¹‰å­—æ¯/æ•°å­—ä¸²ã€ä¹±ç ã€‚
    *   **ç®€å•è¡¨æƒ…/é¢œæ–‡å­—**ï¼šå•ç‹¬æˆ–ä¸»è¦åŒ…å«å¸¸ç”¨è¡¨æƒ…ç¬¦å· (å¦‚ \`ğŸ˜‚\` \`ğŸ¤£\` \`ğŸ‘\` \`ğŸ˜\`) æˆ–é¢œæ–‡å­— (å¦‚ \`(^_^)\` \`(ï½¡Å_Å)\`) ä¸”æ— å®è´¨æ–‡å­—ã€‚
    *   **ç®€å•é—®å€™/å‘Šåˆ«/æ„Ÿè°¢**ï¼šå¦‚ \`ä¸»æ’­å¥½\` \`æˆ‘æ¥äº†\` \`ä¸‹äº†\` \`æ‹œæ‹œ\` \`è°¢è°¢\` \`è¾›è‹¦äº†\`ï¼ˆæ— å…¶ä»–å†…å®¹ï¼‰ã€‚
    *   **ç®€å•æ— è„‘è·Ÿé£/å¤è¯»**ï¼šæ— æ„ä¹‰åœ°é‡å¤ä»–äººå‘è¨€æˆ–æµè¡Œè¯­ã€‚
    *   **çº¯ç²¹çš„æƒ…ç»ªå‘æ³„**ï¼šå•ä¸€çš„ \`å“ˆå“ˆå“ˆå“ˆå“ˆ\` \`awsl\` \`666\` \`ç‰›é€¼\`ï¼ˆæ— ä¸Šä¸‹æ–‡å…³è”æˆ–é™„åŠ ä¿¡æ¯ï¼‰ã€‚
    *   **æ ¸å¿ƒç‰¹å¾ï¼š** ä¿¡æ¯é‡æä½ï¼Œå¯¹ç†è§£å†…å®¹æˆ–ç¤¾åŒºäº’åŠ¨æ— æ˜æ˜¾ä»·å€¼ï¼Œå±äºå¯å¿½ç•¥çš„"å™ªéŸ³"ã€‚

# è¾“å‡ºè¦æ±‚
*   **è¾“å‡ºæ ¼å¼ï¼šä¸¥æ ¼ä½¿ç”¨JSONæ ¼å¼ï¼**
*   **JSONç»“æ„ï¼š**
    {
      "classification": "VIOLATION" | "IMPORTANT" | "LOW_VALUE",  // å¿…é€‰ï¼ä¸‰é€‰ä¸€ï¼Œå¤§å†™ï¼
      "confidence": 0.8,  // å¿…é€‰ï¼0.0 - 1.0 ä¹‹é—´çš„æµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºä½ å¯¹åˆ†ç±»ç»“æœçš„ç½®ä¿¡åº¦ã€‚
      "reason": "ç®€è¦è§£é‡Šåˆ†ç±»åŸå› ï¼Œé‡ç‚¹å¼•ç”¨å¼¹å¹•ä¸­è§¦å‘è¯¥åˆ†ç±»çš„å…³é”®è¯æˆ–ç‰¹å¾ã€‚", // å¿…é€‰ï¼ç®€æ˜æ‰¼è¦ï¼
      "flags": [  // å¯é€‰ï¼æä¾›æ›´ç»†ç²’åº¦çš„æ ‡ç­¾ï¼ˆé€‰æ‹©æœ€ç›¸å…³çš„1-3ä¸ªï¼‰ã€‚
        "hate_speech", // å¦‚ï¼šhate_speech, porn, violence, advertisement, spam, question, topic_relevant, praise, off_topic, simple_emotion...
      ]
    }
*   **ä¼˜å…ˆçº§ï¼š** åªè¦è§¦å‘\`è¿è§„(VIOLATION)\`æ¡ä»¶ï¼Œæ— è®ºæ˜¯å¦æ»¡è¶³å…¶ä»–ç±»åˆ«ï¼Œ**å¿…é¡»**åˆ†ç±»ä¸º\`VIOLATION\`ï¼
*   **è°¨æ…åŸåˆ™ï¼š** å¯¹äºæ¨¡æ£±ä¸¤å¯ã€éš¾ä»¥åˆ¤æ–­æ˜¯å¦è¿è§„çš„å†…å®¹ï¼Œ**ä¼˜å…ˆ**å½’å…¥\`LOW_VALUE\`æˆ–\`IMPORTANT\`ï¼ˆé¿å…è¿‡åº¦å®¡æŸ¥ï¼‰ã€‚ä»…åœ¨æ˜ç¡®è¿åè§„åˆ™æ—¶æ‰æ ‡è®°\`VIOLATION\`ã€‚

# ç¤ºä¾‹
å¼¹å¹•ï¼š "ä¸»æ’­è¿™æ³¢æ“ä½œå¤ªä¸‹é¥­äº†ï¼Œèœå¾—æŠ è„šï¼"
è¾“å‡ºï¼š {"classification": "VIOLATION", "confidence": 0.9, "reason": "åŒ…å«äººèº«æ”»å‡»'èœå¾—æŠ è„š'ã€‚", "flags": ["personal_attack"]}

å¼¹å¹•ï¼š "è¯·é—®åˆšæ‰æ¼”ç¤ºçš„ä»£ç ä¸­ï¼Œä¸ºä»€ä¹ˆè¦ç”¨é—­åŒ…è€Œä¸ç”¨å…¨å±€å˜é‡ï¼Ÿ"
è¾“å‡ºï¼š {"classification": "IMPORTANT", "confidence": 0.95, "reason": "æå‡ºäº†å…³äºæ¼”ç¤ºå†…å®¹çš„å…·ä½“æŠ€æœ¯é—®é¢˜ã€‚", "flags": ["question", "topic_relevant"]}

å¼¹å¹•ï¼š "å‰æ–¹é«˜èƒ½é¢„è­¦ï¼3åˆ†15ç§’æœ‰æƒŠå–œï¼"
è¾“å‡ºï¼š {"classification": "IMPORTANT", "confidence": 0.85, "reason": "æä¾›äº†ä¸è§†é¢‘å†…å®¹ç›¸å…³çš„å…³é”®æ—¶é—´ç‚¹ä¿¡æ¯ã€‚", "flags": ["key_information"]}

å¼¹å¹•ï¼š "å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ"
è¾“å‡ºï¼š {"classification": "LOW_VALUE", "confidence": 0.75, "reason": "ä»…ä¸ºç®€å•æƒ…ç»ªè¡¨è¾¾ï¼Œæ— å®è´¨å†…å®¹ã€‚", "flags": ["simple_emotion"]}

å¼¹å¹•ï¼š "æ™šä¸Šå¥½~ å¤§å®¶åƒäº†å—ï¼Ÿ"
è¾“å‡ºï¼š {"classification": "LOW_VALUE", "confidence": 0.8, "reason": "ç®€å•é—®å€™ï¼Œä¸ç›´æ’­å†…å®¹æ— å…³ã€‚", "flags": ["greeting", "off_topic"]}

å¼¹å¹•ï¼š "è¿™ä¸ªè§‚ç‚¹æˆ‘ä¸åŒæ„ï¼Œæˆ‘è®¤ä¸ºXXXæ‰æ˜¯ä¸»è¦åŸå› ï¼Œç†ç”±æœ‰ä¸‰ï¼š1... 2... 3..."
è¾“å‡ºï¼š {"classification": "IMPORTANT", "confidence": 0.88, "reason": "é’ˆå¯¹å†…å®¹æå‡ºäº†æœ‰ç†æœ‰æ®çš„ä¸åŒè§è§£ã€‚", "flags": ["insightful_comment"]}

å¼¹å¹•ï¼š "åŠ VXï¼š123456789 çœ‹ç¦åˆ©å›¾"
è¾“å‡ºï¼š {"classification": "VIOLATION", "confidence": 0.99, "reason": "åŒ…å«è”ç³»æ–¹å¼'VXï¼š123456789'åŠè¯±å¯¼'çœ‹ç¦åˆ©å›¾'ï¼Œå±åƒåœ¾å¹¿å‘Šã€‚", "flags": ["advertisement", "porn"]}

å¼¹å¹•ï¼š "666"
è¾“å‡ºï¼š {"classification": "LOW_VALUE", "confidence": 0.7, "reason": "ç®€å•æƒ…ç»ªè¡¨è¾¾'666'ï¼Œæ— å…¶ä»–ä¿¡æ¯ã€‚", "flags": ["simple_emotion"]}
`

// ä½¿ç”¨DeepSeekæ¥å£æ¥è¿‡æ»¤å¼¹å¹•
var url = "https://api.deepseek.com/v1/chat/completions";
var data = {
    "model": "deepseek-chat",
    "messages": [
        { "role": "system", "content": prompt },
        { "role": "user", "content": danmu }
    ]
};

var response = fetch(url, {
    method: "POST",
    headers: {
        "Authorization": "Bearer sk-123456ã€ä½ çš„DSç§˜é’¥ã€‘",
        "Content-Type": "application/json"
    },
    body: JSON.stringify(data)
});

json_data = JSON.parse(response)

// åˆ¤æ–­æ˜¯å¦æœ‰æ•ˆ
if (json_data['choices'] == null || json_data['choices'] == undefined) {
    console.log(json_data);
    return ">localNotify('æ²¡æœ‰choices')";
}

var result = json_data['choices'][0]['message']['content'];
// è·å–ç¬¬ä¸€ä¸ª{å’Œæœ€åä¸€ä¸ª}åŠä¹‹é—´çš„å†…å®¹
var start = result.indexOf('{');
var end = result.lastIndexOf('}')
if (start == -1 || end == -1) {
    console.log(result);
    return ">localNotify('ä¸æ˜¯JSONæ ¼å¼')";
}
var json_result = result.substring(start, end + 1);

// åˆ†æJSON
json_data = JSON.parse(json_result);
var classification = json_data['classification']; // VIOLATION | IMPORTANT | LOW_VALUE
var confidence = json_data['confidence']; // 0.0 - 1.0 ä¹‹é—´çš„æµ®ç‚¹æ•°
var reason = json_data['reason']; // ç®€è¦è§£é‡Šåˆ†ç±»åŸå› ï¼Œé‡ç‚¹å¼•ç”¨å¼¹å¹•ä¸­è§¦å‘è¯¥åˆ†ç±»çš„å…³é”®è¯æˆ–ç‰¹å¾ã€‚
var flags = json_data['flags']; // å¯é€‰ï¼æä¾›æ›´ç»†ç²’åº¦çš„æ ‡ç­¾ï¼ˆé€‰æ‹©æœ€ç›¸å…³çš„1-3ä¸ªï¼‰ã€‚

// ã€æ˜¾ç¤ºè¯¥åŠŸèƒ½çš„æ•ˆæœè¯´æ˜ï¼ˆå¯é€‰ï¼‰ã€‘
var output_str = "";
if (classification == "VIOLATION") {
    output_str = "[è¿è§„]";
} else if (classification == "IMPORTANT") {
    output_str = "[é‡è¦]";
} else {
    output_str = "[ä¸é‡è¦]";
}
output_str += "(" + confidence + ") " + reason;
console.log(output_str);

// è¿‡æ»¤è¿è§„å¼¹å¹•
if (classification == "VIOLATION") {
    return ">reject()";
}

// ã€è¿‡æ»¤ä¸é‡è¦çš„å¼¹å¹•ï¼ˆå¯é€‰ï¼‰ã€‘
if (classification == "LOW_VALUE") {
    return ">reject()";
}

return "";